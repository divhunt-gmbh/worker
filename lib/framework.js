const AddonItemCrud={Create(t=null){return new Promise(((e,i)=>{const n=this.addon.Table();null===t&&(t=this.addon.divhunt.Dependency("knex"));const s={};n.fields.forEach((t=>{"id"!==t&&(s[t]=this.Get(t))})),s.created_at=t.fn.now(),s.updated_at=t.fn.now(),t(n.name).insert(s).returning("*").then((([t])=>{Object.entries(t).forEach((([t,e])=>{this.Set(t,e)})),e(this)})).catch((t=>{this.addon.divhunt.LogError(t.message,{operation:"Create",addon:this.addon.GetName(),item:this.Get("id")},t),i(t)}))}))},Update(){},Delete(){}},AddonItemFunctions={Fn(t,...e){return this.addon.FnRun("item."+t,this,...e)}},AddonItemGet={Get(t,e=!0){if(Array.isArray(t)){const i={};return t.forEach((t=>{i[t]=this.Get(t,e)})),i}const i=this.addon.FieldGet(t),n=this.addon.FieldGet("*");if(!i&&!n&&"id"!==t)return null;let s=this.data[t];return i?.get.forEach((t=>{s=t(s,this)})),n?.get.forEach((t=>{s=t(s,this)})),i?.define?s=this.addon.divhunt.DataDefineOne(s,i.define):n?.define&&(s=this.addon.divhunt.DataDefineOne(s,n.define)),e&&this.addon.divhunt.Emit("addon.item.get",this,t,s),s},GetData(t=!0){let e={};return Object.entries(e).forEach((([i,n])=>{e[i]=this.Get(i,t)})),e}},AddonItemRemove={Remove(t=!0){this.addon.ItemRemove(this.data.id,t)}},AddonItemSet={Set(t,e,i=!0){const n=this.addon.FieldGet(t),s=this.addon.FieldGet("*");if(!n&&!s)return;const r=this.data[t];n?.set?.forEach((t=>{e=t(e,r,this)})),s?.set?.forEach((t=>{e=t(e,r,this)})),n?.define?e=this.addon.divhunt.DataDefineOne(e,n.define):s?.define&&(e=this.addon.divhunt.DataDefineOne(e,s.define)),i&&this.addon.divhunt.Emit("addon.item.set",this,t,e,r),this.data[t]=e},SetData(t,e=!0){Object.entries(t).forEach((([t,i])=>{this.Set(t,i,e)}))}};class DivhuntAddonItem{constructor(t,e){this.addon=t,this.data=e}}Object.assign(DivhuntAddonItem.prototype,AddonItemGet),Object.assign(DivhuntAddonItem.prototype,AddonItemSet),Object.assign(DivhuntAddonItem.prototype,AddonItemRemove),Object.assign(DivhuntAddonItem.prototype,AddonItemFunctions),Object.assign(DivhuntAddonItem.prototype,AddonItemCrud);const AddonClone={Clone(){try{const t=new DivhuntAddon(this.divhunt(),this.name+"_clone");t.__fields={},Object.values(this.__fields).forEach((e=>{t.__fields[e.name]={name:e.name,define:e.define,get:[],set:[]},e.get.forEach((i=>{t.__fields[e.name].get.push(i)})),e.set.forEach((i=>{t.__fields[e.name].set.push(i)}))})),t.__fields_callbacks={add:[...this.__fields_callbacks.add],remove:[...this.__fields_callbacks.remove]},t.__items={},t.__items_id=this.__items_id,Object.values(this.__items).forEach((e=>{const i=Object.assign({},e.GetData());delete i.id,t.ItemAdd(i,null,!1)})),t.__items_callbacks={add:[...this.__items_callbacks.add],get:[...this.__items_callbacks.get],set:[...this.__items_callbacks.set],remove:[...this.__items_callbacks.remove]},t.__functions={},Object.entries(this.__functions).forEach((([e,i])=>{t.__functions[e]={callback:i.callback,before:[...i.before||[]],after:[...i.after||[]],trigger:i.trigger}}));try{this.divhunt.Hook("addon.clone",this,t)}catch(t){}return t}catch(t){throw t}}},AddonFields={Field(t,e=null,i=null,n=null,s=!0){return this.FieldGet(t)||this.FieldAdd(t,e,i,n,s)},Fields(t,e=null,i=null,n=null){return this.fields},FieldAdd(t,e=null,i=null,n=null,s=!0){return t in this.fields.data||(this.fields.data[t]={name:t,define:null,get:[],set:[]}),null!==e&&(this.fields.data[t].define=e),null!==i&&this.fields.data[t].get.push(i),null!==n&&this.fields.data[t].set.push(n),s&&(this.fields.callbacks.add.forEach((e=>e.call(this,this.fields.data[t]))),this.divhunt.Emit("addon.field.add",this,this.fields.data[t])),this.fields.data[t]},FieldGet(t){return this.fields.data[t]},FieldRemove(t,e=!0){t in this.fields&&(e&&(this.fields.callbacks.remove.forEach((e=>e.call(this,this.fields.data[t]))),this.divhunt.Emit("addon.field.remove",this,this.fields.data[t])),delete this.fields.data[t])},FieldOn(t,e){if(!(t in this.fields.callbacks))return this.LogWarn("Field catcher not found.",{name}),this;this.fields.callbacks[t].push(e)}},AddonFind={Find(t=null){const e={filters:[],sort:null,limit:10,page:0},i=["=","!=","<",">","<=",">=","LIKE","NOT LIKE","ILIKE","NOT ILIKE","IN","NOT IN"],n={};return null===t&&(t=this.divhunt.Dependency("knex")),n.limit=t=>{if("number"!=typeof t||0>=t)throw Error("Limit must be a positive number");return e.limit=t,n},n.page=t=>{if("number"!=typeof t||0>t)throw Error("Page must be a non-negative number");return e.page=t,n},n.sort=(t,i="asc")=>{if(!/^[a-zA-Z][a-zA-Z0-9_]{0,63}$/.test(t))throw Error("Invalid field name: "+t);if(i=i.toLowerCase(),!["asc","desc"].includes(i))throw Error('Sort direction must be "asc" or "desc"');return e.sort={field:t,direction:i},n},n.filter=(t,s,r="=",a="AND")=>{if(!/^[a-zA-Z][a-zA-Z0-9_]{0,63}$/.test(t))throw Error("Invalid field name: "+t);if(!i.includes(r))throw Error(`Invalid operator: ${r}. Allowed operators are: ${i.join(", ")}`);if(!1===["number","string","boolean"].includes(typeof s))throw Error("Value must be a string, number or boolean");return e.filters.push({field:t,value:s,operator:r,type:"AND"===a?"AND":"OR"}),n},n.many=async(i=!1)=>{const n=this.Table();try{const s=t(n.name).select(n.fields);return this.FindApplyFilters(s,e.filters),e.sort&&s.orderBy(e.sort.field,e.sort.direction),e.limit>0&&(s.limit(e.limit),e.page>0)&&s.offset(e.page*e.limit),(await s).map((t=>this.ItemAdd(t,null,!1,i)))}catch(t){throw this.divhunt.LogError("Find query failed",{query:e},t),t}},n.count=async()=>{const i=this.Table();try{const n=t(i.name).count("* as count");this.FindApplyFilters(n,e.filters);const s=await n;return parseInt(s[0]?.count||0)}catch(t){throw this.divhunt.LogError("Count query failed",{query:e},t),t}},n.one=async(t=!1)=>{const e=await n.limit(1).many(t);return e.length>0?e[0]:null},n},FindApplyFilters(t,e){e&&0!==e.length&&t.where((function(){e.forEach(((t,e)=>{const{field:i,value:n,operator:s,type:r}=t,a=0===e?"where":"OR"===r?"orWhere":"andWhere";if("IN"===s||"NOT IN"===s){const t=Array.isArray(n)?n:[n];this[a](i,s.toLowerCase(),t)}else this[a](i,s.toLowerCase(),n)}))}))}},AddonFunctions={FnAdd(t,e){if("object"==typeof t)return Object.entries(t).forEach((([t,e])=>this.FnAdd(t,e))),this;if(t=t.toLowerCase(),"function"!=typeof e)return this.divhunt.LogWarn('Function "'+t+'" callback is not a function.'),this;this.functions.data[t]={callback:e,name:t};try{this.functions.callbacks.add.forEach((e=>e.call(this,this.functions.data[t]))),this.divhunt.Emit("addon.function.add",t)}catch(e){this.divhunt.LogError('Error in function "'+t+'" callback add.',{},e)}return this},FnGet(t){return t=t.toLowerCase(),this.functions.data[t]||null},FnRun(t,...e){t=t.toLowerCase();const i=this.FnGet(t);if(!i)return this.divhunt.LogError("Function not found.",{name:t}),null;let n=null;const s=Object.create(this);s.methods={};try{this.functions.callbacks.before.forEach((t=>t.call(s,i,...e))),this.divhunt.Emit("addon.function.before",this,i,n,...e)}catch(e){this.divhunt.LogError("Error in function callback before.",{name:t},e)}try{n=i.callback.call(s,...e)}catch(e){this.divhunt.LogError("Error in function callback.",{name:t},e)}try{this.functions.callbacks.after.forEach((t=>t.call(s,i,n,...e))),this.divhunt.Emit("addon.function.after",s,i,n,...e)}catch(e){this.divhunt.LogError("Error in function callback after.",{name:t},e)}return n},FnRemove(t){const e=this.FnGet(t);if(!e)return this;try{this.functions.callbacks.remove.forEach((t=>t.call(this,e))),this.divhunt.Emit("addon.function.remove",this,e)}catch(t){this.divhunt.LogError("Error in function callback remove.",{name:e.name},t)}return delete this.functions.data[e.name],this},FnOn(t,e){if(!(t in this.functions.callbacks))return this.LogWarn("Item catcher not found.",{type:t});this.functions.callbacks[t].push(e)},Fn(t,...e){return!this.FnGet(t)&&e.length&&"function"==typeof e[0]?this.FnAdd(t,...e):this.FnRun(t,...e)}},AddonGet={GetName(){return this.name}},AddonItems={Item(t,e=null,i=!0){return t&&"object"==typeof t?this.ItemAdd(t,e,i):this.ItemGet(t,e)},Items(){return this.items.data},ItemGet(t,e=null){return t in this.items.data?(e&&e(this.items.data[t]),this.items.data[t]):null},ItemAdd(t,e=null,i=!0){this.FieldGet("id")||this.FieldAdd("id",["number"]);let n=new DivhuntAddonItem(this,{});return"id"in t||(t.id=this.items.id++),n.SetData(t,!1),i&&(this.items.callbacks.add.forEach((t=>t.call(this,n))),this.divhunt.Emit("addon.item.add",this,n)),e&&e(n),this.items.data[n.Get("id")]=n,n},ItemRemove(t,e=!0){const i=this.ItemGet(t);i&&(e&&(this.items.callbacks.remove.forEach((t=>t.call(this,i))),this.divhunt.Emit("addon.item.remove",this,i)),delete this.items.data[t])},ItemsRemove(t=!0){if(t)for(let e in this.items.data)this.ItemRemove(e,t);else this.items.data={}},ItemOn(t,e){if(!(t in this.items.callbacks))return this.LogWarn("Item catcher not found for: "+t+"."),this;this.items.callbacks[t].push(e)}},AddonRemove={Remove(t=!0){this.divhunt.AddonRemove(this.name,t)}},AddonTable={Table(t=null,e=[]){return null===t?this.TableGet():this.TableSet(t,e)},TableSet(t,e=[]){this.table.name=t,this.table.fields=e},TableGet(){return this.table},TableOn(t,e){t in this.table.callbacks&&this.table.callbacks.on(t,e)}};class DivhuntAddon{constructor(t,e){this.divhunt=t,this.name=e,this.table={name:null,fields:[],callbacks:{get:[],create:[],update:[],delete:[]}},this.fields={data:{},callbacks:{add:[],remove:[]}},this.functions={data:{},callbacks:{before:[],after:[],add:[],remove:[]}},this.items={data:{},id:1,callbacks:{add:[],remove:[]}}}}Object.assign(DivhuntAddon.prototype,AddonGet),Object.assign(DivhuntAddon.prototype,AddonFields),Object.assign(DivhuntAddon.prototype,AddonItems),Object.assign(DivhuntAddon.prototype,AddonRemove),Object.assign(DivhuntAddon.prototype,AddonFunctions),Object.assign(DivhuntAddon.prototype,AddonClone),Object.assign(DivhuntAddon.prototype,AddonTable),Object.assign(DivhuntAddon.prototype,AddonFind);const Addons={Addon(t,e=null,i=!0){return this.AddonGet(t)?this.AddonGet(t,e):this.AddonAdd(t,e,i)},AddonAdd(t,e=null,i=!0){t=t.toLowerCase();const n=new DivhuntAddon(this,t);if(this.addons.data[t]=n,i)try{this.addons.callbacks.add.forEach((t=>t(n))),this.Emit("addon.add",n)}catch(e){this.LogError("Error while performing addon add callback.",{addon:t},e)}return this.AddonGet(t,e)},AddonGet(t,e=null){return(t=t.toLowerCase())in this.addons.data?(e&&e(this.addons.data[t]),this.addons.data[t]):null},Addons(){return this.addons.data},AddonRemove(t,e=!0){const i=this.AddonGet(t);if(i){if(e)try{this.addons.callbacks.remove.forEach((t=>t(i))),this.Emit("addon.remove",i)}catch(e){this.LogError("Error while performing addon remove callback.",{addon:t},e)}i.ItemsRemove(e),delete this.addons.items[t]}},AddonsRemove(t=!0){for(let e in this.addons.items)this.AddonRemove(e,t)},AddonOn(t,e){if(!(t in this.addons.callbacks))return this.LogWarn("Addon catcher not found.",{addon:t});this.addons.callbacks[t].push(e)}},Data={DataDefine(t,e,i=0){if(i>10)return this.LogError("Data definition depth limit reached.",{limit:10,data:t}),null;for(const[n,s]of Object.entries(e))t[n]=this.DataDefineOne(t[n],s,i+1);return t},DataDefineOne(t,e,i=0){let n,s,r,a;if(Array.isArray(e)?(n=(e[0]+"").toLowerCase(),s=e[1],r=e[2]):e&&"object"==typeof e?(n=(e.type+"").toLowerCase(),s=e.value,r=e.required,a=e.config):(n=typeof e,s=e),this.DataTypeMatch(t,n)||(t=s&&this.DataTypeMatch(s,n)?this.DataPrimitiveValue(t,s):null),r&&null==t&&this.LogError(`Required field "${n}" is missing in data.`,{data:t}),!a)return t;if(n.includes("array")){Array.isArray(t)||(t=[]);const e=[];for(let n=0;t.length>n;n++){const s=this.DataDefineOne(t[n],a,i+1);null!=s&&e.push(s)}t=e}return n.includes("object")&&(t&&"object"==typeof t||(t={}),t=this.DataDefine(t,a,i+1)),t},DataTypeMatch:(t,e)=>("string"==typeof e?e.split("|").map((t=>t.trim().toLowerCase())):[]).some((e=>{const i=typeof t;return"string"===e?"string"===i:"number"===e?"number"===i:"boolean"===e?"boolean"===i:"function"===e?"function"===i:"array"===e?Array.isArray(t):"object"===e&&"object"===i&&!Array.isArray(t)&&null!==t})),DataPrimitiveValue:(t,e=null)=>null==t||typeof t!=typeof e||Array.isArray(t)!==Array.isArray(e)?e:t},Dependencies={Dependency(t,e=null){return null===e?this.DependencyGet(t,!1):this.DependencyAdd(t,e)},Dependencies(){return this.dependencies.items},DependencyGet(t,e=!0){return this.DependencyHas(t)?e?this.dependencies.items[t]:this.dependencies.items[t].value:null},DependencyAdd(t,e,i=!0){const n=this.dependencies.items[t]={name:t,value:e};if(i)try{this.dependencies.callbacks.add.forEach((t=>t(n)))}catch(e){this.LogError("Error while performing dependency add callback.",{name:t},e)}return this.Emit("dependency.add",n),this},DependencyHas(t){return t in this.dependencies.items},DependencyRemove(t,e=!0){const i=this.DependencyGet(t);if(i){if(e)try{this.dependencies.callbacks.remove.forEach((t=>t(i)))}catch(e){this.LogError("Error while performing dependency remove callback.",{name:t},e)}return this.Emit("dependency.remove",i),delete this.dependencies.items[t],this}}},Emitter={Emit(t,...e){(t=t.toLowerCase())in this.emitters&&this.emitters[t].forEach((i=>{try{i.callback(...e),i.once&&this.EmitOff(t,i.id)}catch(e){this.LogError("Error in emitter callback.",{name:t,addon:this.GetName()},e)}}))},EmitOn(t,e){t=t.toLowerCase(),this.emitters[t]||(this.emitters[t]=[]);const i=this.GenerateUID();return this.emitters[t].push({id:i,once:!1,callback:e}),i},EmitOnce(t,e){t=t.toLowerCase(),this.emitters[t]||(this.emitters[t]=[]);const i=this.GenerateUID();return this.emitters[t].push({id:i,once:!0,callback:e}),i},EmitOff(t,e){(t=t.toLowerCase())in this.emitters&&(this.emitters[t]=this.emitters[t].filter((t=>t.id!==e)))}},Generate={GenerateHash(t){let e=0;for(let i=0;t.length>i;i++)e=(e<<5)-e+t.charCodeAt(i),e|=0;return Math.abs(e).toString(16)},GenerateUID:()=>Math.random().toString(36).slice(2,11),GenerateString(t=10,e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789"){let i="";const n=e.length;for(let s=0;t>s;s++)i+=e.charAt(Math.floor(Math.random()*n));return i},GenerateTID(){let t=Date.now(),e=(""+Math.floor(1e6*Math.random())).padStart(6,"0");return parseInt(`${t}${e}`)}},Logger={Log(t,e,i={}){if(!(t in this.logger.levels))throw Error(`Invalid log level: '${t}'`);return i.allowed=this.logger.levels[t]>=this.logger.levels[this.logger.level],i.timestamp=(new Date).toISOString(),i.level=t,i.message=e,this.Emit("log",i),this},LogLevel(t){if(!(t in this.logger.levels))throw Error(`Invalid log level: '${t}'`);return this},LogError(t,e={},i=null,n=1,s=!1){if(e.stack=i?i.stack.split("\n").splice(1,n):[],this.Log("error",t+(i?" / "+i.message:""),e),s)throw i||Error(t)},LogWarn(t,e={}){return this.Log("warn",t,e)},LogInfo(t,e={}){return this.Log("info",t,e)},LogVerbose(t,e={}){return this.Log("verbose",t,e)},LogDebug(t,e={}){return this.Log("debug",t,e)},LogSilly(t,e={}){return this.Log("silly",t,e)}},Middleware={async Middleware(t,e){let i=-1;const n={value:e,errors:[],next:async()=>{if(i++,this.middleware[t].length>i)try{return await this.middleware[t][i](n)}catch(e){this.LogError("Error in middleware callback: "+t,{},e)}return n}};return this.middleware[t]||(this.middleware[t]=[]),await n.next()},MiddlewareIntercept(t,e){return this.middleware[t]||(this.middleware[t]=[]),this.middleware[t].push(e),this}},Request={Request(t,e){t=t.toLowerCase();const i={value:e};return this.Emit("request."+t,i),"value"in i&&typeof i.value==typeof e?i.value:e},RequestCatch(t,e){t=t.toLowerCase(),this.EmitOn("request."+t,e)}},String={StringSanitize(t){const e="string"!=typeof t?JSON.stringify(t):t,i={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"};return e.replace(/[&<>"']/g,(t=>i[t]))},StringHasTemplateKey(t,e){if("string"!=typeof t||"string"!=typeof e)return!1;const i=/\{\{\s*([^}]+)\s*\}\}/g,n=RegExp(`(^|[^\\w.])${e.replace(/\./g,"\\.")}($|[^\\w])`);let s;for(;null!==(s=i.exec(t));){const t=s[1].trim();if(n.test(t))return!0}return!1},StringCompileTemplate:(t,e)=>"string"!=typeof t?"":e&&"object"==typeof e?t.replace(/\{\{\s*([^}]+)\s*\}\}/g,((t,i)=>{try{const n=i.trim().split(".");let s=e,r=0;const a=5;for(const e of n){if(null==s||r>a)return t;s=s[e],r++}return null!=s?s+"":t}catch(e){return t}})):t,StringExtractUnit(t,e="px"){const i=(t+"").match(/^(\d+)(%|px|em|rem|vh|vw|pt)?$/);return i?{value:parseInt(i[1],10),unit:i[2]||e}:{value:0,unit:e}},StringTruncate:(t,e=100,i="...")=>("string"!=typeof t&&(t+=""),t.length>e?t.slice(0,e-i.length)+i:t),StringCapitalize:t=>"string"==typeof t&&t.length?t.charAt(0).toUpperCase()+t.slice(1):"",StringToCamelCase(t){return"string"!=typeof t?"":t.replace(/[^\w\s]/g," ").split(/\s+/).filter((t=>t.length)).map(((t,e)=>0===e?t.toLowerCase():this.StringCapitalize(t.toLowerCase()))).join("")},StringStripHtml:t=>"string"!=typeof t?"":t.replace(/<style[^>]*>.*?<\/style>/gs,"").replace(/<script[^>]*>.*?<\/script>/gs,"").replace(/<[^>]+>/g,"").replace(/&nbsp;/g," ").replace(/&amp;/g,"&").replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&quot;/g,'"').replace(/&#039;/g,"'").replace(/\s+/g," ").trim(),StringSlugify:t=>"string"!=typeof t?"":t.toLowerCase().trim().replace(/\s+/g,"-").replace(/[^\w-]+/g,"").replace(/--+/g,"-").replace(/^-+|-+$/g,""),StringFormatNumber(t,e=2,i=".",n=","){if(isNaN(t))return"0";const s=parseFloat(t).toFixed(e).split(".");return s[0]=s[0].replace(/\B(?=(\d{3})+(?!\d))/g,n),s.join(i)}};class Divhunt{constructor(){this.emitters={},this.middleware={},this.addons={data:{},callbacks:{add:[],remove:[]}},this.dependencies={items:{},callbacks:{add:[],remove:[]}},this.logger={levels:{error:0,warn:1,info:2,http:3,verbose:4,debug:5,silly:6},level:"error"}}}Object.assign(Divhunt.prototype,Addons),Object.assign(Divhunt.prototype,Emitter),Object.assign(Divhunt.prototype,Generate),Object.assign(Divhunt.prototype,Request),Object.assign(Divhunt.prototype,Data),Object.assign(Divhunt.prototype,String),Object.assign(Divhunt.prototype,Middleware),Object.assign(Divhunt.prototype,Logger),Object.assign(Divhunt.prototype,Dependencies);export default Divhunt;