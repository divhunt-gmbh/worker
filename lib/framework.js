const AddonItemCrud={Create(t=null){return new Promise(((e,i)=>{const n=this.addon.Table();null===t&&(t=this.addon.divhunt.Dependency("knex"));const s={};n.fields.forEach((t=>{"id"!==t&&(s[t]=this.Get(t))})),s.created_at=t.fn.now(),s.updated_at=t.fn.now(),t(n.name).insert(s).returning("*").then((([t])=>{Object.entries(t).forEach((([t,e])=>{this.Set(t,e)})),e(this)})).catch((t=>{this.addon.divhunt.LogError(t.message,{operation:"Create",table:n,data:this.data},t),i(t)}))}))},Update(){return new Promise(((t,e)=>{const i=this.addon.Table(),n=this.addon.divhunt.Dependency("knex");try{if(!this.Get("id"))throw Error("Item id is required.");const e={};i.fields.forEach((t=>{"id"!==t&&(e[t]=this.Get(t))})),e.updated_at=n.fn.now(),n(i.name).where("id","=",this.Get("id")).update(e).then((e=>{if(0===e)throw Error("Record not found or no changes made.");this.data.updated_at=new Date,t(this)}))}catch(t){this.addon.divhunt.LogError(t.message,{operation:"Update",table:i,data:this.data},t),e(t)}}))},Delete(){return new Promise(((t,e)=>{const i=this.addon.Table(),n=this.addon.divhunt.Dependency("knex");try{if(!this.Get("id"))throw Error("Item id is required.");n(i.name).where("id","=",this.Get("id")).delete().then((e=>{if(0===e)throw Error("Record not found.");t(this)}))}catch(t){this.addon.divhunt.LogError(t.message,{operation:"Delete",table:i,data:this.data},t),e(t)}}))}},AddonItemFunctions={Fn(t,...e){return this.addon.FnRun("item."+t,this,...e)}},AddonItemGet={Get(t,e=!0){const i=this.addon.FieldGet(t),n=this.addon.FieldGet("*");if(!i&&!n&&"id"!==t)return null;let s=this.data[t];return e&&(i?.get.forEach((t=>{s=t(s,this)})),n?.get.forEach((t=>{s=t(s,this)}))),s},GetData(){return this.data}},AddonItemRemove={Remove(t=!0){this.addon.ItemRemove(this.data.id,t)}},AddonItemSet={Set(t,e,i=!0){const n=this.addon.FieldGet(t),s=this.addon.FieldGet("*");if(!n&&!s)return;const r=this.data[t];i&&(n?.set?.forEach((i=>{e=i(t,e,this,r)})),s?.set?.forEach((i=>{e=i(t,e,this,r)}))),this.data[t]=e},SetData(t,e=!0){Object.entries(t).forEach((([t,i])=>{this.Set(t,i,e)}))}};class DivhuntAddonItem{constructor(t,e){this.addon=t,this.data=e}}Object.assign(DivhuntAddonItem.prototype,AddonItemGet),Object.assign(DivhuntAddonItem.prototype,AddonItemSet),Object.assign(DivhuntAddonItem.prototype,AddonItemRemove),Object.assign(DivhuntAddonItem.prototype,AddonItemFunctions),Object.assign(DivhuntAddonItem.prototype,AddonItemCrud);const AddonClone={Clone(){try{const t=new DivhuntAddon(this.divhunt,this.name+"_clone_"+this.divhunt.GenerateTID());t.__fields={},Object.values(this.__fields).forEach((e=>{t.__fields[e.name]={name:e.name,define:e.define,get:[],set:[]},e.get.forEach((i=>{t.__fields[e.name].get.push(i)})),e.set.forEach((i=>{t.__fields[e.name].set.push(i)}))})),t.__fields_callbacks={add:[...this.__fields_callbacks.add],remove:[...this.__fields_callbacks.remove]},t.__items={},t.__items_id=this.__items_id,Object.values(this.__items).forEach((e=>{const i=Object.assign({},e.GetData());delete i.id,t.ItemAdd(i,null,!1)})),t.__items_callbacks={add:[...this.__items_callbacks.add],get:[...this.__items_callbacks.get],set:[...this.__items_callbacks.set],remove:[...this.__items_callbacks.remove]},t.__functions={},Object.entries(this.__functions).forEach((([e,i])=>{t.__functions[e]={callback:i.callback,before:[...i.before||[]],after:[...i.after||[]],trigger:i.trigger}}));try{this.divhunt.Emit("addon.clone",this,t)}catch(t){}return t}catch(t){throw t}}},AddonFields={FieldAdd(t,e=null,i=null,n=null,s=!0){return t in this.__fields||(this.__fields[t]={name:t,define:null,get:[],set:[]}),null!==e&&(this.__fields[t].define=e),null!==i&&this.__fields[t].get.push(i),null!==n&&this.__fields[t].set.push(n),s&&this.__fields_callbacks.add.forEach((e=>e.call(this,this.__fields[t]))),this.divhunt.Emit("addon.field.add",this,this.__fields[t]),this.__fields[t]},Field(t,e=null,i=null,n=null,s=!0){return this.FieldGet(t)||this.FieldAdd(t,e,i,n,s)},FieldGet(t){return this.__fields[t]},FieldsGet(t,e=null,i=null,n=null){return this.__fields},FieldRemove(t,e=!0){t in this.__fields&&(e&&this.__fields_callbacks.remove.forEach((e=>e.call(this,this.__fields[t]))),this.divhunt.Emit("addon.field.remove",this,this.__fields[t]),delete this.__fields[t])},FieldOn(t,e){if(!(t in this.__fields_callbacks))return this.LogWarn("Item catcher not found for: "+t+"."),this;this.__fields_callbacks[t].push(e)}},AddonFind={Find(t=null){const e={filters:[],sort:null,limit:10,page:0},i=["=","!=","<",">","<=",">=","LIKE","NOT LIKE","ILIKE","NOT ILIKE","IN","NOT IN"],n={};return null===t&&(t=this.divhunt.Dependency("knex")),n.limit=t=>{if("number"!=typeof t||0>=t)throw Error("Limit must be a positive number");return e.limit=t,n},n.page=t=>{if("number"!=typeof t||0>t)throw Error("Page must be a non-negative number");return e.page=t,n},n.sort=(t,i="asc")=>{if(!/^[a-zA-Z][a-zA-Z0-9_]{0,63}$/.test(t))throw Error("Invalid field name: "+t);if(i=i.toLowerCase(),!["asc","desc"].includes(i))throw Error('Sort direction must be "asc" or "desc"');return e.sort={field:t,direction:i},n},n.filter=(t,s,r="=",o="AND")=>{if(!/^[a-zA-Z][a-zA-Z0-9_]{0,63}$/.test(t))throw Error("Invalid field name: "+t);if(!i.includes(r))throw Error(`Invalid operator: ${r}. Allowed operators are: ${i.join(", ")}`);if(!1===["number","string","boolean"].includes(typeof s))throw Error("Value must be a string, number or boolean");return e.filters.push({field:t,value:s,operator:r,type:"AND"===o?"AND":"OR"}),n},n.many=async(i=!1)=>{const n=this.Table();try{const s=t(n.name).select(n.fields);return this.FindApplyFilters(s,e.filters),e.sort&&s.orderBy(e.sort.field,e.sort.direction),e.limit>0&&(s.limit(e.limit),e.page>0)&&s.offset(e.page*e.limit),(await s).map((t=>this.ItemAdd(t,null,!1,i)))}catch(t){throw this.divhunt.LogError("Find query failed",{query:e},t),t}},n.count=async()=>{const i=this.Table();try{const n=t(i.name).count("* as count");this.FindApplyFilters(n,e.filters);const s=await n;return parseInt(s[0]?.count||0)}catch(t){throw this.divhunt.LogError("Count query failed",{query:e},t),t}},n.one=async(t=!1)=>{const e=await n.limit(1).many(t);return e.length>0?e[0]:null},n},FindApplyFilters(t,e){e&&0!==e.length&&t.where((function(){e.forEach(((t,e)=>{const{field:i,value:n,operator:s,type:r}=t,o=0===e?"where":"OR"===r?"orWhere":"andWhere";if("IN"===s||"NOT IN"===s){const t=Array.isArray(n)?n:[n];this[o](i,s.toLowerCase(),t)}else this[o](i,s.toLowerCase(),n)}))}))}},AddonFunctions={FnAdd(t,e){if("object"==typeof t)return Object.entries(t).forEach((([t,e])=>this.FnAdd(t,e))),this;if(t=t.toLowerCase(),"function"!=typeof e)return this.divhunt.LogWarn('Function "'+t+'" callback is not a function.'),this;this.__functions[t]={callback:e,name:t};try{this.__functions_callbacks.add.forEach((e=>e.call(this,this.__functions[t]))),this.divhunt.Emit("addon.function.add",t)}catch(e){this.divhunt.LogError('Error in function "'+t+'" callback add.',{},e)}return this},FnGet(t){return t=t.toLowerCase(),this.__functions[t]||null},FnRun(t,...e){t=t.toLowerCase();const i=this.FnGet(t);if(!i)return null;let n=null;try{this.__functions_callbacks.before.forEach((i=>i.call(this,this.__functions[t],...e))),this.divhunt.Emit("addon.function.before",this,this.__functions[t],n,...e)}catch(e){this.divhunt.LogError('Error in function "'+t+'" callback before.',{},e)}try{n=i.callback.call(this,...e)}catch(e){this.divhunt.LogError('Error in function "'+t+'" callback.',{},e)}try{this.__functions_callbacks.after.forEach((i=>i.call(this,t,n,...e))),this.divhunt.Emit("addon.function.after",this,this.__functions[this.__functions[t]],n,...e)}catch(e){this.divhunt.LogError('Error in function "'+t+'" callback after.',{},e)}return n},FnRemove(t){t=t.toLowerCase();try{this.__functions_callbacks.remove.forEach((e=>e.call(this,this.__functions[t]))),this.divhunt.Emit("addon.function.remove",this,this.__functions[t])}catch(e){this.divhunt.LogError('Error in function "'+t+'" callback remove.',{},e)}return delete this.__functions[t],this},FnOn(t,e){if(!(t in this.__functions_callbacks))return this.LogWarn("Item catcher not found for: "+t+".");this.__functions_callbacks[t].push(e)},Fn(t,...e){return!this.FnGet(t)&&e.length&&"function"==typeof e[0]?this.FnAdd(t,...e):this.FnRun(t,...e)}},AddonGet={GetName(){return this.name}},AddonItems={Items(){return this.__items},ItemGet(t,e=null){return t in this.__items?(e&&e(this.__items[t]),this.__items[t]):null},Item(t,e=null,i=!0){return t?"object"==typeof t?this.ItemAdd(t,e,i):this.ItemGet(t,e):null},ItemAdd(t,e=null,i=!0,n=!0){t&&"object"==typeof t||(t={}),"id"in t||(t.id=this.__items_id+++"");let s={};return t.id in this.__items&&(s=this.__items[t.id]),s=this.ItemValidate(s,t),s=new DivhuntAddonItem(this,s),n&&(this.__items[s.data.id]=s),i&&this.__items_callbacks.add.forEach((t=>t.call(this,s))),this.divhunt.Emit("addon.item.add",this,s),e&&e(s),s},ItemValidate(t,e){const i=this.FieldGet("*");return Object.entries(e).forEach((([e,i])=>{t[e]=i})),Object.entries(t).forEach((([e,n])=>{const s=this.FieldGet(e);s||i?s?.define?t[e]=this.divhunt.DataDefineOne(t[e],s.define):i?.define&&"object"==typeof i.define&&e in i.define&&(t[e]=this.divhunt.DataDefineOne(t[e],i.define[e])):"id"!==e?delete t[e]:t[e]=n})),t},ItemRemove(t,e=!0){const i=this.ItemGet(t);i&&(e&&this.__items_callbacks.remove.forEach((t=>t.call(this,i))),this.divhunt.Emit("addon.item.remove",this,i),delete this.__items[t])},ItemsRemove(t=!0){if(t)for(let e in this.__items)this.ItemRemove(e,t);else this.__items={}},ItemOn(t,e){if(!(t in this.__items_callbacks))return this.LogWarn("Item catcher not found for: "+t+"."),this;this.__items_callbacks[t].push(e)}},AddonRemove={Remove(t=!0){this.divhunt.AddonRemove(this.name,t)}},AddonTable={Table(t=null,e=[]){if(null===t)return this.__table;this.__table.name=t,this.__table.fields=e},TableOn(t,e){t in this.__table.callbacks&&this.__table.callbacks.on(t,e)}};class DivhuntAddon{constructor(t,e){this.divhunt=t,this.name=e,this.__table={name:null,fields:[],callbacks:{create:[],read:[],update:[],delete:[]}},this.__fields={},this.__fields_callbacks={add:[],remove:[]},this.__functions={},this.__functions_callbacks={before:[],after:[],add:[],remove:[]},this.__items={},this.__items_id=1,this.__items_callbacks={add:[],get:[],set:[],remove:[]}}}Object.assign(DivhuntAddon.prototype,AddonGet),Object.assign(DivhuntAddon.prototype,AddonFields),Object.assign(DivhuntAddon.prototype,AddonItems),Object.assign(DivhuntAddon.prototype,AddonRemove),Object.assign(DivhuntAddon.prototype,AddonFunctions),Object.assign(DivhuntAddon.prototype,AddonClone),Object.assign(DivhuntAddon.prototype,AddonTable),Object.assign(DivhuntAddon.prototype,AddonFind);const Addons={Addon(t,e=null){return this.AddonGet(t)?this.AddonGet(t,e):this.AddonAdd(t,e)},AddonAdd(t,e=null,i=!0){t=t.toLowerCase();const n=new DivhuntAddon(this,t);if(this.__addons[t]=n,i)try{this.__addons_callbacks.add.forEach((t=>t(n)))}catch(t){this.LogError("Error while performing addon add callback.",{},t)}return this.Emit("addon.add",n),this.AddonGet(t,e)},AddonGet(t,e=null){return(t=t.toLowerCase())in this.__addons?(e&&e(this.__addons[t]),this.__addons[t]):null},AddonsGet(){return this.__addons},AddonRemove(t,e=!0){const i=this.AddonGet(t);if(i){if(e)try{this.__addons_callbacks.remove.forEach((t=>t(i)))}catch(t){this.LogError("Error while performing addon remove callback.",{},t)}this.Emit("addon.remove",i),i.ItemsRemove(e),delete this.__addons[t]}},AddonsRemove(t=!0){for(let e in this.__addons)this.AddonRemove(e,t)},AddonOn(t,e){if(!(t in this.__addons_callbacks))return this.LogWarn("Addon catcher not found for: "+t+".");this.__addons_callbacks[t].push(e)}},Data={DataDefine(t,e,i=0){if(i>5)return t;for(const[n,s]of Object.entries(e))"function"==typeof s?(t[n]&&"object"==typeof t[n]||(t[n]={}),t[n]=this.DataDefineOne(t[n],s(),i+1)):t[n]=this.DataDefineOne(t[n],s,i+1);return t},DataDefineOne(t,e){if(null==e)return t;if("function"==typeof e)return this.DataDefine({},e());if(Array.isArray(e)){const[i,n]=e;return this.DataTypeMatch(t,i)?t:this.DataPrimitiveValue(t,n)}return this.DataPrimitiveValue(t,e)},DataTypeMatch:(t,e)=>("string"==typeof e?e.split("|").map((t=>t.trim().toLowerCase())):[]).some((e=>{const i=typeof t;return"string"===e?"string"===i:"number"===e?"number"===i:"boolean"===e?"boolean"===i:"function"===e?"function"===i:"array"===e?Array.isArray(t):"object"===e&&"object"===i&&!Array.isArray(t)&&null!==t})),DataPrimitiveValue:(t,e=null)=>null==t||typeof t!=typeof e||Array.isArray(t)!==Array.isArray(e)?e:t},DivhuntDependencies={Dependency(t,e=null){return null===e?this.DependencyGet(t,!1):this.DependencyAdd(t,e)},DependencyGet(t,e=!0){return this.DependencyHas(t)?e?this.__dependencies.items[t]:this.__dependencies.items[t].value:null},DependencyAdd(t,e,i=!0){const n=this.__dependencies.items[t]={name:t,value:e};if(i)try{this.__dependencies.callbacks.add.forEach((t=>t(n)))}catch(t){this.LogError("Error while performing dependency add callback.",{},t)}return this.Emit("dependency.add",n),this},DependencyHas(t){return t in this.__dependencies.items},DependencyRemove(t,e=!0){const i=this.DependencyGet(t);if(i){if(e)try{this.__dependencies.callbacks.remove.forEach((t=>t(i)))}catch(t){this.LogError("Error while performing dependency remove callback.",{},t)}return this.Emit("dependency.remove",i),delete this.__dependencies.items[t],this}}},Emitter={Emit(t,...e){(t=t.toLowerCase())in this.__emitters&&this.__emitters[t].forEach((i=>{try{i.callback(...e),i.once&&this.EmitOff(t,i.id)}catch(e){this.LogError(`Error in emitter '${t}' callback.`,{},e)}}))},EmitOn(t,e){t=t.toLowerCase(),this.__emitters[t]||(this.__emitters[t]=[]);const i=this.GenerateUID();return this.__emitters[t].push({id:i,once:!1,callback:e}),i},EmitOnce(t,e){t=t.toLowerCase(),this.__emitters[t]||(this.__emitters[t]=[]);const i=this.GenerateUID();return this.__emitters[t].push({id:i,once:!0,callback:e}),i},EmitOff(t,e){(t=t.toLowerCase())in this.__emitters&&(this.__emitters[t]=this.__emitters[t].filter((t=>t.id!==e)))}},Generate={GenerateHash(t){let e=0;for(let i=0;t.length>i;i++)e=(e<<5)-e+t.charCodeAt(i),e|=0;return Math.abs(e).toString(16)},GenerateUID:()=>Math.random().toString(36).slice(2,11),GenerateString(t=10,e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789"){let i="";const n=e.length;for(let s=0;t>s;s++)i+=e.charAt(Math.floor(Math.random()*n));return i},GenerateTID(){let t=Date.now(),e=(""+Math.floor(1e6*Math.random())).padStart(6,"0");return parseInt(`${t}${e}`)}},Logger={Log(t,e,i={}){if(!(t in this.__logger.levels))throw Error(`Invalid log level: '${t}'`);return i.allowed=this.__logger.levels[t]>=this.__logger.levels[this.__logger.level],i.timestamp=(new Date).toISOString(),i.level=t,i.message=e,this.Emit("log",i),this},LogLevel(t){if(!(t in this.__logger.levels))throw Error(`Invalid log level: '${t}'`);return this},LogError(t,e={},i=null,n=1){return e.stack=i?i.stack.split("\n").splice(1,n):[],this.Log("error",t+i?" / "+i.message:"",e)},LogWarn(t,e={}){return this.Log("warn",t,e)},LogInfo(t,e={}){return this.Log("info",t,e)},LogVerbose(t,e={}){return this.Log("verbose",t,e)},LogDebug(t,e={}){return this.Log("debug",t,e)},LogSilly(t,e={}){return this.Log("silly",t,e)}},Middleware={async Middleware(t,e){let i=-1;const n={value:e,errors:[],next:async()=>{if(i++,this.__middleware[t].length>i)try{return await this.__middleware[t][i](n)}catch(e){this.LogError("Error in middleware callback: "+t,{},e)}return n}};return this.__middleware[t]||(this.__middleware[t]=[]),await n.next()},MiddlewareIntercept(t,e){return this.__middleware[t]||(this.__middleware[t]=[]),this.__middleware[t].push(e),this}},Request={Request(t,e){t=t.toLowerCase();const i={value:e};return this.Emit("request."+t,i),"value"in i&&typeof i.value==typeof e?i.value:e},RequestCatch(t,e){t=t.toLowerCase(),this.EmitOn("request."+t,e)}},String={StringSanitize(t){const e="string"!=typeof t?JSON.stringify(t):t,i={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"};return e.replace(/[&<>"']/g,(t=>i[t]))},StringHasTemplateKey(t,e){if("string"!=typeof t||"string"!=typeof e)return!1;const i=/\{\{\s*([^}]+)\s*\}\}/g,n=RegExp(`(^|[^\\w.])${e.replace(/\./g,"\\.")}($|[^\\w])`);let s;for(;null!==(s=i.exec(t));){const t=s[1].trim();if(n.test(t))return!0}return!1},StringCompileTemplate:(t,e)=>"string"!=typeof t?"":e&&"object"==typeof e?t.replace(/\{\{\s*([^}]+)\s*\}\}/g,((t,i)=>{try{const n=i.trim().split(".");let s=e,r=0;const o=5;for(const e of n){if(null==s||r>o)return t;s=s[e],r++}return null!=s?String(s):t}catch(e){return t}})):t,StringExtractUnit(t,e="px"){const i=String(t).match(/^(\d+)(%|px|em|rem|vh|vw|pt)?$/);return i?{value:parseInt(i[1],10),unit:i[2]||e}:{value:0,unit:e}},StringTruncate:(t,e=100,i="...")=>("string"!=typeof t&&(t=String(t)),t.length>e?t.slice(0,e-i.length)+i:t),StringCapitalize:t=>"string"==typeof t&&t.length?t.charAt(0).toUpperCase()+t.slice(1):"",StringToCamelCase(t){return"string"!=typeof t?"":t.replace(/[^\w\s]/g," ").split(/\s+/).filter((t=>t.length)).map(((t,e)=>0===e?t.toLowerCase():this.StringCapitalize(t.toLowerCase()))).join("")},StringStripHtml:t=>"string"!=typeof t?"":t.replace(/<style[^>]*>.*?<\/style>/gs,"").replace(/<script[^>]*>.*?<\/script>/gs,"").replace(/<[^>]+>/g,"").replace(/&nbsp;/g," ").replace(/&amp;/g,"&").replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&quot;/g,'"').replace(/&#039;/g,"'").replace(/\s+/g," ").trim(),StringSlugify:t=>"string"!=typeof t?"":t.toLowerCase().trim().replace(/\s+/g,"-").replace(/[^\w-]+/g,"").replace(/--+/g,"-").replace(/^-+|-+$/g,""),StringFormatNumber(t,e=2,i=".",n=","){if(isNaN(t))return"0";const s=parseFloat(t).toFixed(e).split(".");return s[0]=s[0].replace(/\B(?=(\d{3})+(?!\d))/g,n),s.join(i)}};class Divhunt{constructor(){this.__addons={},this.__addons_callbacks={add:[],remove:[]},this.__dependencies={items:{},callbacks:{add:[],remove:[]}},this.__emitters={},this.__middleware={},this.__logger={levels:{error:0,warn:1,info:2,http:3,verbose:4,debug:5,silly:6},level:"error"}}}Object.assign(Divhunt.prototype,Addons),Object.assign(Divhunt.prototype,Emitter),Object.assign(Divhunt.prototype,Generate),Object.assign(Divhunt.prototype,Request),Object.assign(Divhunt.prototype,Data),Object.assign(Divhunt.prototype,String),Object.assign(Divhunt.prototype,Middleware),Object.assign(Divhunt.prototype,Logger),Object.assign(Divhunt.prototype,DivhuntDependencies);export default Divhunt;